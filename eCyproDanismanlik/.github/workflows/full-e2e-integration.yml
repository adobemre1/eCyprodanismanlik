name: Full E2E Integration Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      target_platforms:
        description: 'Target platforms (comma-separated: vercel,render)'
        required: false
        default: 'vercel,render'
      skip_tests:
        description: 'Skip tests for faster deployment'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

jobs:
  # Initial quality checks
  quality-check:
    name: Quality & Security Checks
    runs-on: ubuntu-latest
    outputs:
      quality_passed: ${{ steps.quality.outputs.passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: lint
        run: npm run lint

      - name: Run build test
        id: build
        run: npm run build

      - name: Quality assessment
        id: quality
        run: |
          if [ "${{ steps.lint.outcome }}" == "success" ] && [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

  # Performance and security testing
  performance-test:
    name: Performance & Security Testing
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: needs.quality-check.outputs.quality_passed == 'true' && (github.event_name != 'workflow_dispatch' || !github.event.inputs.skip_tests)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: .lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

  # Multi-platform deployment matrix
  deploy-matrix:
    name: Deploy to ${{ matrix.platform }}
    runs-on: ubuntu-latest
    needs: [quality-check, performance-test]
    if: needs.quality-check.outputs.quality_passed == 'true' && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    strategy:
      matrix:
        platform: [vercel, render]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build

      - name: Deploy to Vercel
        if: matrix.platform == 'vercel'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -n "$VERCEL_TOKEN" ] && [ -n "$VERCEL_PROJECT_ID" ]; then
            npm i -g vercel
            vercel --token $VERCEL_TOKEN --prod --yes
            echo "âœ… Vercel deployment completed"
          else
            echo "âš ï¸  Vercel credentials not configured, skipping..."
          fi

      - name: Deploy to Render
        if: matrix.platform == 'render'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
            curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": false}'
            echo "âœ… Render deployment completed"
          else
            echo "âš ï¸  Render credentials not configured, skipping..."
          fi

  # Final notification and summary
  finalize:
    name: Finalize & Notify
    runs-on: ubuntu-latest
    needs: [deploy-matrix]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "## ðŸš€ E2E Integration Deployment Summary" >> deployment-summary.md
          echo "" >> deployment-summary.md
          echo "### ðŸ“Š Deployment Results:" >> deployment-summary.md
          echo "- **Quality Checks**: ${{ needs.quality-check.result }}" >> deployment-summary.md
          echo "- **Performance Tests**: ${{ needs.performance-test.result }}" >> deployment-summary.md
          echo "- **Deployments**: ${{ needs.deploy-matrix.result }}" >> deployment-summary.md
          echo "" >> deployment-summary.md
          echo "### ðŸŽ¯ Deployed Platforms:" >> deployment-summary.md

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IFS=',' read -ra PLATFORMS <<< "${{ github.event.inputs.target_platforms }}"
            for platform in "${PLATFORMS[@]}"; do
              echo "- $platform: ${{ needs.deploy-matrix.result }}" >> deployment-summary.md
            done
          else
            echo "- Vercel: ${{ needs.deploy-matrix.result }}" >> deployment-summary.md
            echo "- Render: ${{ needs.deploy-matrix.result }}" >> deployment-summary.md
          fi

          echo "" >> deployment-summary.md
          echo "### ðŸ”— Access URLs:" >> deployment-summary.md
          echo "- **GitHub Repository**: https://github.com/${GITHUB_REPOSITORY}" >> deployment-summary.md
          echo "- **GitHub Actions**: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> deployment-summary.md

          cat deployment-summary.md

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          DEPLOYMENT_SUMMARY=$(cat deployment-summary.md)

          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\":\"ðŸŽ‰ E2E Integration Pipeline Completed\",
              \"blocks\":[
                {
                  \"type\":\"header\",
                  \"text\":{
                    \"type\":\"plain_text\",
                    \"text\":\"ðŸš€ E2E Integration Pipeline Results\"
                  }
                },
                {
                  \"type\":\"section\",
                  \"text\":{
                    \"type\":\"mrkdwn\",
                    \"text\":\"*Repository:* ${GITHUB_REPOSITORY}\n*Branch:* ${GITHUB_REF#refs/heads/}\n*Commit:* ${GITHUB_SHA::8}\"
                  }
                },
                {
                  \"type\":\"section\",
                  \"text\":{
                    \"type\":\"mrkdwn\",
                    \"text\":\"*Quality Checks:* ${{ needs.quality-check.result }} ðŸŸ¢\n*Performance Tests:* ${{ needs.performance-test.result }} ðŸŸ¢\n*Deployments:* ${{ needs.deploy-matrix.result }} ðŸŸ¢\"
                  }
                },
                {
                  \"type\":\"section\",
                  \"text\":{
                    \"type\":\"mrkdwn\",
                    \"text\":\"ðŸ”— *Links:*\nâ€¢ <https://github.com/${GITHUB_REPOSITORY}|Repository>\nâ€¢ <https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|Pipeline Run>\"
                  }
                }
              ]
            }"

      - name: Upload deployment summary
        uses: actions/upload-artifact@v3
        with:
          name: deployment-summary
          path: deployment-summary.md
